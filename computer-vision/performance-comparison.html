<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOM Scanner Performance Comparison</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      color: #1a73e8;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    button:hover {
      background: #1557b0;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: #5f6368;
    }

    button.secondary:hover {
      background: #3c4043;
    }

    .results {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 30px;
    }

    .result-box {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      background: #fafafa;
    }

    .result-box h3 {
      margin-top: 0;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .badge.old {
      background: #ffeaa7;
      color: #d63031;
    }

    .badge.new {
      background: #55efc4;
      color: #00b894;
    }

    .metric {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .metric:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: #666;
      font-size: 14px;
    }

    .metric-value {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }

    .metric-value.fast {
      color: #00b894;
    }

    .metric-value.slow {
      color: #d63031;
    }

    .comparison {
      margin-top: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      color: white;
    }

    .comparison h3 {
      margin-top: 0;
      color: white;
    }

    .improvement {
      font-size: 48px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
    }

    .improvement-text {
      text-align: center;
      font-size: 18px;
      opacity: 0.9;
    }

    .test-elements {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .test-elements h3 {
      margin-top: 0;
    }

    /* Generate test elements */
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .test-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    .test-input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
    }

    .test-link {
      color: #1a73e8;
      text-decoration: none;
      padding: 10px;
      display: block;
      border: 1px solid #1a73e8;
      border-radius: 6px;
      text-align: center;
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }

    .loader.active {
      display: block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .console-output {
      margin-top: 20px;
      padding: 15px;
      background: #1e1e1e;
      color: #00ff00;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .console-line {
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸš€ DOM Scanner Performance Comparison</h1>
    <p class="subtitle">Testing efficiency improvements between old and new DOM scanning algorithms</p>

    <div class="controls">
      <button onclick="runLegacyScan()">Run Legacy Scanner</button>
      <button onclick="runEfficientScan()">Run Efficient Scanner</button>
      <button onclick="runBothScans()">Compare Both</button>
      <button class="secondary" onclick="generateMoreElements()">Generate More Elements</button>
      <button class="secondary" onclick="clearResults()">Clear Results</button>
    </div>

    <div class="loader" id="loader"></div>

    <div class="results">
      <div class="result-box" id="legacy-results">
        <h3>
          Legacy Scanner
          <span class="badge old">OLD</span>
        </h3>
        <div id="legacy-metrics">
          <p style="color: #999;">Run legacy scanner to see results...</p>
        </div>
      </div>

      <div class="result-box" id="efficient-results">
        <h3>
          Efficient Scanner
          <span class="badge new">NEW</span>
        </h3>
        <div id="efficient-metrics">
          <p style="color: #999;">Run efficient scanner to see results...</p>
        </div>
      </div>
    </div>

    <div class="comparison" id="comparison" style="display: none;">
      <h3>âš¡ Performance Improvement</h3>
      <div class="improvement" id="improvement-percent">-</div>
      <div class="improvement-text" id="improvement-text">-</div>
    </div>

    <div class="test-elements">
      <h3>Test Elements on Page: <span id="element-count">50</span></h3>
      <div class="test-grid" id="test-grid">
        <!-- Elements will be generated here -->
      </div>
    </div>

    <div class="console-output" id="console">
      <div class="console-line">> Console output will appear here...</div>
    </div>
  </div>

  <!-- Load the efficient scanner -->
  <script src="efficient-dom-scanner.js"></script>

  <script>
    // Console logging
    function log(message, type = 'info') {
      const console = document.getElementById('console');
      const line = document.createElement('div');
      line.className = 'console-line';
      line.textContent = `> ${new Date().toLocaleTimeString()}: ${message}`;
      console.appendChild(line);
      console.scrollTop = console.scrollHeight;
    }

    // Generate test elements
    function generateElements(count = 50) {
      const grid = document.getElementById('test-grid');
      grid.innerHTML = '';

      const elementTypes = [
        () => {
          const btn = document.createElement('button');
          btn.className = 'test-btn';
          btn.textContent = `Button ${Math.floor(Math.random() * 1000)}`;
          btn.setAttribute('data-testid', `btn-${Math.random().toString(36).substr(2, 9)}`);
          return btn;
        },
        () => {
          const input = document.createElement('input');
          input.className = 'test-input';
          input.placeholder = `Input ${Math.floor(Math.random() * 1000)}`;
          input.setAttribute('aria-label', `Test input ${Math.random()}`);
          return input;
        },
        () => {
          const link = document.createElement('a');
          link.className = 'test-link';
          link.href = '#';
          link.textContent = `Link ${Math.floor(Math.random() * 1000)}`;
          link.setAttribute('role', 'button');
          return link;
        }
      ];

      for (let i = 0; i < count; i++) {
        const type = elementTypes[Math.floor(Math.random() * elementTypes.length)];
        grid.appendChild(type());
      }

      document.getElementById('element-count').textContent = count;
      log(`Generated ${count} test elements`);
    }

    // Legacy scanner (from original content.js)
    function legacyScan() {
      const startTime = performance.now();

      const interactiveSelectors = `
        button, input, select, textarea, a[href],
        [onclick], [role="button"], [role="tab"], [role="menuitem"],
        .btn, .button, .tab, .menu-item, .nav-item,
        [data-testid], [aria-label], [title],
        form, .form, .search, .login, .signup,
        .test-btn, .test-input, .test-link
      `;

      const elements = document.querySelectorAll(interactiveSelectors);

      const elementData = Array.from(elements).map((el, index) => {
        const rect = el.getBoundingClientRect();

        return {
          id: `element-${index}`,
          text: el.textContent?.trim().substring(0, 100) || '',
          type: el.tagName.toLowerCase(),
          position: {
            x: rect.left,
            y: rect.top,
            width: rect.width,
            height: rect.height
          },
          visible: rect.width > 0 && rect.height > 0
        };
      }).filter(data => data.visible);

      const endTime = performance.now();
      const duration = endTime - startTime;

      return {
        duration: duration,
        elementsFound: elements.length,
        visibleElements: elementData.length,
        method: 'Legacy (querySelectorAll + getBoundingClientRect)'
      };
    }

    // Run legacy scan
    async function runLegacyScan() {
      log('Starting legacy scan...');
      document.getElementById('loader').classList.add('active');

      setTimeout(() => {
        const results = legacyScan();

        document.getElementById('legacy-metrics').innerHTML = `
          <div class="metric">
            <span class="metric-label">Scan Duration</span>
            <span class="metric-value slow">${results.duration.toFixed(2)}ms</span>
          </div>
          <div class="metric">
            <span class="metric-label">Elements Found</span>
            <span class="metric-value">${results.elementsFound}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Visible Elements</span>
            <span class="metric-value">${results.visibleElements}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Method</span>
            <span class="metric-value" style="font-size: 11px;">${results.method}</span>
          </div>
        `;

        log(`Legacy scan complete: ${results.duration.toFixed(2)}ms, ${results.visibleElements} elements`);
        document.getElementById('loader').classList.remove('active');

        window.legacyResults = results;
      }, 100);
    }

    // Run efficient scan
    async function runEfficientScan() {
      log('Starting efficient scan...');
      document.getElementById('loader').classList.add('active');

      const scanner = new EfficientDOMScanner();

      try {
        const startTime = performance.now();
        const elements = await scanner.scanPageElements({
          maxElements: 200,
          priority: 'balanced',
          useCache: false
        });
        const endTime = performance.now();

        const metrics = scanner.getMetrics();
        const duration = endTime - startTime;

        const results = {
          duration: duration,
          elementsFound: elements.length,
          visibleElements: elements.filter(e => e.visible).length,
          cacheHitRate: metrics.cacheHitRate,
          method: 'Efficient (TreeWalker + IntersectionObserver + Caching)'
        };

        document.getElementById('efficient-metrics').innerHTML = `
          <div class="metric">
            <span class="metric-label">Scan Duration</span>
            <span class="metric-value fast">${results.duration.toFixed(2)}ms</span>
          </div>
          <div class="metric">
            <span class="metric-label">Elements Found</span>
            <span class="metric-value">${results.elementsFound}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Visible Elements</span>
            <span class="metric-value">${results.visibleElements}</span>
          </div>
          <div class="metric">
            <span class="metric-label">Cache Hit Rate</span>
            <span class="metric-value">${(results.cacheHitRate * 100).toFixed(1)}%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Method</span>
            <span class="metric-value" style="font-size: 11px;">${results.method}</span>
          </div>
        `;

        log(`Efficient scan complete: ${results.duration.toFixed(2)}ms, ${results.visibleElements} elements`);
        document.getElementById('loader').classList.remove('active');

        window.efficientResults = results;
      } catch (error) {
        log(`Error in efficient scan: ${error.message}`, 'error');
        document.getElementById('loader').classList.remove('active');
      }
    }

    // Run both and compare
    async function runBothScans() {
      await runLegacyScan();
      await new Promise(resolve => setTimeout(resolve, 500));
      await runEfficientScan();

      // Calculate improvement
      if (window.legacyResults && window.efficientResults) {
        const improvement = ((window.legacyResults.duration - window.efficientResults.duration) / window.legacyResults.duration) * 100;
        const speedup = (window.legacyResults.duration / window.efficientResults.duration).toFixed(1);

        document.getElementById('comparison').style.display = 'block';
        document.getElementById('improvement-percent').textContent = `${improvement.toFixed(1)}% Faster`;
        document.getElementById('improvement-text').textContent = `${speedup}x speedup - Efficient scanner is ${speedup} times faster!`;

        log(`ðŸŽ‰ Improvement: ${improvement.toFixed(1)}% faster (${speedup}x speedup)`);
      }
    }

    // Generate more elements
    function generateMoreElements() {
      const current = parseInt(document.getElementById('element-count').textContent);
      const newCount = current + 50;
      generateElements(newCount);
    }

    // Clear results
    function clearResults() {
      document.getElementById('legacy-metrics').innerHTML = '<p style="color: #999;">Run legacy scanner to see results...</p>';
      document.getElementById('efficient-metrics').innerHTML = '<p style="color: #999;">Run efficient scanner to see results...</p>';
      document.getElementById('comparison').style.display = 'none';
      document.getElementById('console').innerHTML = '<div class="console-line">> Console cleared...</div>';
      log('Results cleared');
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      generateElements(50);
      log('Page loaded - ready to test!');
    });
  </script>
</body>
</html>
